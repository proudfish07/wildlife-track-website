<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>穿山甲追蹤地圖 - 多個體選單動態地圖</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Leaflet 地圖樣式 -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    body { margin:0; padding:0; }
    #controls {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 1000;
      background: rgba(255,255,255,0.98);
      padding: 12px 18px 10px 14px;
      border-radius: 10px;
      box-shadow: 0 0 8px rgba(0,0,0,0.3);
      font-size: 16px;
      min-width: 230px;
      max-width: 400px;
    }
    #map { height: 100vh; width: 100vw; }
    .legend {
      background: white;
      line-height: 1.5;
      padding: 10px;
      font-size: 14px;
      border-radius: 8px;
      box-shadow: 0 0 5px rgba(0,0,0,0.3);
    }
    .legend img {
      vertical-align: middle;
      height: 20px;
      width: 20px;
    }
    .info-control {
      background: white;
      line-height: 1.7;
      padding: 12px 14px;
      font-size: 15px;
      border-radius: 8px;
      box-shadow: 0 0 5px rgba(0,0,0,0.3);
      margin: 10px;
      min-width: 260px;
      max-width: 400px;
      word-break: break-all;
    }
    .leaflet-control.compass-custom {
      background: white;
      padding: 4px;
      border-radius: 6px;
      box-shadow: 0 0 6px rgba(0,0,0,0.2);
    }
    .leaflet-control.compass-custom img {
      width: 40px;
      height: 40px;
      display: block;
    }
    @media (max-width: 700px) {
      #controls { font-size: 13px; min-width:150px; max-width:95vw; }
      .legend { font-size: 12px; }
      .info-control { font-size: 13px; min-width:150px; }
    }
  </style>
</head>
<body>
  <div id="controls">
    <label for="individual-select"><b>選擇個體：</b></label>
    <select id="individual-select"></select>
    <span id="loading-indicator" style="color:#999;display:none">載入中...</span>
    <div id="individual-info" style="margin-top:10px; font-size:14px; color:#555;"></div>
  </div>
  <div id="map"></div>

  <!-- Leaflet & 相關外掛 -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <!-- 若需 GPX，可引入 GPX 外掛 -->
  <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-gpx/1.5.1/gpx.min.js"></script> -->

  <script>
  // ==== 1. 參數設定 ====
  // 請將下行 apiUrl 換成你的 Google Apps Script JSON API 連結
  const apiUrl = "https://script.google.com/macros/s/AKfycbxzXCJaqX3UZu_U7v4KYVEwURWvGE0ykL9JIqcLGbNRpg15hRTilwtOBpYmWe9WUroM/exec";

  // ==== 2. Leaflet 地圖初始化 ====
  const map = L.map('map').setView([22.91, 121.09], 15);
  // 底圖
  const normalMap = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap contributors', maxZoom: 19
  }).addTo(map);
  const contourMap = L.tileLayer('https://tile.opentopomap.org/{z}/{x}/{y}.png', {
    attribution: 'Map data: &copy; OpenTopoMap (CC-BY-SA)', maxZoom: 17
  });
  const satelliteMap = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
    attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, etc', maxZoom: 19
  });
  const baseMaps = {
    "一般地圖": normalMap,
    "等高線地圖": contourMap,
    "衛星圖": satelliteMap
  };
  L.control.layers(baseMaps, null, {collapsed:true, position:'topright'}).addTo(map);
  L.control.scale().addTo(map);

  // ==== 3. 圖層組 ====
  const trackGroup = L.layerGroup().addTo(map);
  const trackPointsGroup = L.layerGroup().addTo(map);
  const markerGroup = L.layerGroup().addTo(map);
  const monitorGroup = L.layerGroup().addTo(map);

  // ==== 4. 自訂圖示 ====
  const animalIcon = L.icon({
    iconUrl: 'animal-icon.png', iconSize: [40, 40], iconAnchor: [20, 40], popupAnchor: [0, -40]
  });
  const eyeIcon = L.icon({
    iconUrl: 'eye-icon.png', iconSize: [25, 25], iconAnchor: [12, 12], popupAnchor: [0, -12]
  });
  const signalIcon = L.icon({
    iconUrl: 'signal-icon.png', iconSize: [25, 25], iconAnchor: [12, 12], popupAnchor: [0, -12]
  });

  // ==== 5. 資訊欄 ====
  const infoControl = L.control({ position: 'topleft' });
  infoControl.onAdd = function(map) {
    const div = L.DomUtil.create('div', 'info-control');
    div.innerHTML = `
      <b>最近工作日</b>：<span id="latest-time">-</span><br>
      <b>最後定位日</b>：<span id="last-success-time">-</span>
    `;
    return div;
  };
  infoControl.addTo(map);

  // ==== 6. 圖例 ====
  const legend = L.control({ position: 'bottomright' });
  legend.onAdd = function(map) {
    const div = L.DomUtil.create('div', 'legend');
    div.innerHTML = `
      <b>圖例</b><br>
      <img src="animal-icon.png"> 最新位置<br>
      <span style="color: blue;">●</span> 移動路徑<br>
      <img src="eye-icon.png"> 發現點<br>
      <img src="signal-icon.png"> 監聽點
    `;
    return div;
  };
  legend.addTo(map);

  // ==== 7. 個體選單載入 ====
  let individuals = [];
  let currentIndividual = null;
  let mainData = null, markerData = null, monitorData = null;
  let layersInitialized = false;

  function showLoading(show) {
    document.getElementById('loading-indicator').style.display = show ? "" : "none";
  }

  // 取得分頁 gid（預設為 0，如需更精準，建議 API 提供 gid）
  function getGidFromUrl(sheetUrl, tabName) {
    // 這裡建議將個體 JSON 結構加入各分頁 gid
    // 若只有一分頁，預設為 gid=0
    return '0';
  }

  // 將個體資訊顯示於 info 區塊
  function renderIndividualInfo(indiv) {
    document.getElementById('individual-info').innerHTML = `
      <b>個體編號：</b>${indiv.id}<br>
      <b>名稱：</b>${indiv.name}<br>
      <a href="${indiv.sheet_url}" target="_blank">Google Sheet 來源</a>
    `;
  }

  // 主渲染函式
  function tryRender() {
    if (!mainData || !markerData || !monitorData) return;
    // 清空 group
    trackGroup.clearLayers();
    trackPointsGroup.clearLayers();
    markerGroup.clearLayers();
    monitorGroup.clearLayers();

    // 最近工作日
    const allWithTS = mainData.filter(d => d.timestamp && d.timestamp.trim() !== "");
    let latestTrack = allWithTS.reduce((max, curr) =>
      (!max || new Date(curr.timestamp) > new Date(max.timestamp)) ? curr : max, null);
    let latestTime = latestTrack && latestTrack.timestamp ? latestTrack.timestamp : '-';

    // 最後定位日
    const allWithTSLatLng = mainData.filter(d =>
      d.timestamp && d.timestamp.trim() !== "" &&
      d.lat && d.lat.trim() !== "" &&
      d.lng && d.lng.trim() !== ""
    );
    let lastSuccessTrack = allWithTSLatLng.reduce((max, curr) =>
      (!max || new Date(curr.timestamp) > new Date(max.timestamp)) ? curr : max, null);
    let lastSuccessTime = lastSuccessTrack && lastSuccessTrack.timestamp ? lastSuccessTrack.timestamp : '-';

    document.getElementById('latest-time').textContent = latestTime;
    document.getElementById('last-success-time').textContent = lastSuccessTime;

    // 畫出主資料 sheet 的軌跡與最新位置
    const trackPoints = allWithTSLatLng
      .sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp))
      .map(d => ({
        lat: parseFloat(d.lat),
        lng: parseFloat(d.lng),
        timestamp: d.timestamp,
        note: d.note
      }));
    const latlngs = trackPoints.map(p => [p.lat, p.lng]);
    if (latlngs.length) {
      // 移動路徑與最新位置
      const polyline = L.polyline(latlngs, { color: 'blue' }).addTo(trackGroup);
      trackPoints.slice(0, -1).forEach(p => {
        if (p.note && p.note.includes('發現點')) {
          L.marker([p.lat, p.lng], { icon: eyeIcon })
            .addTo(trackGroup)
            .bindPopup(`<b>${p.note}</b><br>${p.timestamp}`);
        } else {
          L.circleMarker([p.lat, p.lng], {
            radius: 6, color: 'gray', fillColor: 'gray', fillOpacity: 0.6
          }).addTo(trackGroup).bindPopup(`<b>${p.note || '無備註'}</b><br>${p.timestamp}`);
        }
      });
      const latestPos = trackPoints[trackPoints.length - 1];
      L.marker([latestPos.lat, latestPos.lng], { icon: animalIcon })
        .addTo(trackGroup)
        .bindPopup(`<b>最新位置</b><br>${latestPos.timestamp}<br>${latestPos.note || ''}`);

      // 所有移動點位（不含路徑和最新位置）
      trackPoints.forEach(p => {
        if (p.note && p.note.includes('發現點')) {
          L.marker([p.lat, p.lng], { icon: eyeIcon })
            .addTo(trackPointsGroup)
            .bindPopup(`<b>${p.note}</b><br>${p.timestamp}`);
        } else {
          L.circleMarker([p.lat, p.lng], {
            radius: 6, color: 'gray', fillColor: 'gray', fillOpacity: 0.6
          }).addTo(trackPointsGroup).bindPopup(`<b>${p.note || '無備註'}</b><br>${p.timestamp}`);
        }
      });
      // 聚焦顯示範圍
      map.fitBounds(L.polyline(latlngs).getBounds(), {maxZoom: 16});
    }

    // marker sheet 的點位
    markerData.filter(d => d.lat && d.lng)
      .forEach(p => {
        L.marker([parseFloat(p.lat), parseFloat(p.lng)])
          .addTo(markerGroup)
          .bindPopup(`<b>${p.note || '標記點'}</b>`);
      });

    // 監聽點 sheet 的點位
    monitorData.filter(d => d.lat && d.lng)
      .forEach(p => {
        L.marker([parseFloat(p.lat), parseFloat(p.lng)], { icon: signalIcon })
          .addTo(monitorGroup)
          .bindPopup(`<b>${p.note || '監聽點'}</b>`);
      });
  }

  // 載入個體清單並初始化選單
  fetch(apiUrl)
    .then(res => res.json())
    .then(data => {
      individuals = data;
      const select = document.getElementById('individual-select');
      select.innerHTML = '';
      individuals.forEach((item, idx) => {
        const opt = document.createElement('option');
        opt.value = idx;
        opt.text = `${item.id} - ${item.name}`;
        select.appendChild(opt);
      });
      // 預設載入第一個
      if (individuals.length > 0) {
        select.value = 0;
        loadIndividual(individuals[0]);
        renderIndividualInfo(individuals[0]);
        currentIndividual = individuals[0];
      }
      select.addEventListener('change', function() {
        const idx = parseInt(this.value);
        if (!isNaN(idx) && individuals[idx]) {
          showLoading(true);
          loadIndividual(individuals[idx]);
          renderIndividualInfo(individuals[idx]);
          currentIndividual = individuals[idx];
        }
      });
    });

  // 根據選擇個體載入資料
  function loadIndividual(indiv) {
    showLoading(true);
    mainData = null; markerData = null; monitorData = null;
    // 取得 sheet id
    const sheetIdMatch = indiv.sheet_url.match(/\/d\/([a-zA-Z0-9-_]+)/);
    if (!sheetIdMatch) { alert("Google Sheet 網址格式錯誤！"); return; }
    const sheetId = sheetIdMatch[1];
    // 取得分頁 gid（建議將 gid 寫進 JSON）
    const mainGid = indiv.track_points_gid || getGidFromUrl(indiv.sheet_url, indiv.track_points_tab);
    const markerGid = indiv.annotations_gid || getGidFromUrl(indiv.sheet_url, indiv.annotations_tab);
    const monitorGid = indiv.listening_points_gid || getGidFromUrl(indiv.sheet_url, indiv.listening_points_tab);

    // 組合下載連結
    const mainSheetUrl = `https://docs.google.com/spreadsheets/d/${sheetId}/export?format=csv&gid=${mainGid}`;
    const markerSheetUrl = `https://docs.google.com/spreadsheets/d/${sheetId}/export?format=csv&gid=${markerGid}`;
    const monitorSheetUrl = `https://docs.google.com/spreadsheets/d/${sheetId}/export?format=csv&gid=${monitorGid}`;

    // 載入主資料
    Papa.parse(mainSheetUrl, {
      download: true,
      header: true,
      complete: function(results) {
        mainData = results.data;
        tryRender();
        showLoading(false);
      }
    });
    // 載入 marker
    Papa.parse(markerSheetUrl, {
      download: true,
      header: true,
      complete: function(results) {
        markerData = results.data;
        tryRender();
      }
    });
    // 載入監聽點
    Papa.parse(monitorSheetUrl, {
      download: true,
      header: true,
      complete: function(results) {
        monitorData = results.data;
        tryRender();
      }
    });
  }
  </script>
</body>
</html>
